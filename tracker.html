<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Monthly £1m Milestone Counter</title>
<style>
  :root {
    /* EXB brand palette (white background, cream card) */
    --bg: #ffffff;      /* page background white */
    --card: #efeee8;    /* card cream */
    --track: #d9d9d9;   /* light neutral track */
    --fill: #ff8255;    /* EXB orange (Settled) */
    --fill-muted: #ffb79f; /* Muted orange (Written) */
    --accent: #ff9c77;  /* lighter orange */
    --text: #212121;    /* charcoal */
    --muted: #666666;   /* muted charcoal */
    --good: #ff8255;    /* brand orange */
    --warn: #212121;
    --bad:  #212121;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; height: 100vh; display: grid; place-items: center;
    background: var(--bg);
    color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .card {
    width: min(1100px, 92vw); padding: 28px; background: var(--card);
    border: 1px solid rgba(33,33,33,0.12); border-radius: 20px;
    box-shadow: 0 20px 60px rgba(0,0,0,0.08), inset 0 1px 0 rgba(255,255,255,0.35);
    backdrop-filter: blur(4px);
  }
  .header { display:flex; align-items:baseline; justify-content:space-between; gap:16px; margin-bottom: 18px; }
  .title { font-size: clamp(20px, 3.2vw, 28px); letter-spacing: 0.3px; font-weight: 700; }
  .updated { font-size: 12px; color: var(--muted); }

  .numbers {
    display:grid; grid-template-columns: 1fr auto; gap: 14px; align-items: end; margin-bottom: 6px;
  }
  .big { font-size: clamp(28px, 6vw, 56px); font-weight: 800; line-height: 1; }
  .big .sm { font-weight: 600; font-size: 0.48em; color: var(--muted); margin-left: 8px; }
  .target { text-align: right; color: var(--muted); font-size: clamp(12px, 1.8vw, 16px); }

  .bar-title { display:flex; justify-content:space-between; align-items:baseline; margin: 10px 0 6px; color: var(--muted); font-size: 14px; }
  .bar-value { font-weight: 700; color: var(--text); }

  .bar-wrap {
    position: relative; height: 28px; background: var(--track);
    border-radius: 999px; overflow: hidden; border: 1px solid rgba(33,33,33,0.12);
  }
  .bar-fill, .bar-fill-written {
    position: absolute; inset: 0 auto 0 0; height: 100%; width: 0%;
    transition: width 900ms cubic-bezier(.2,.8,.2,1);
  }
  .bar-fill-written {
    background: linear-gradient(90deg, var(--fill-muted), #ffd8c9);
    box-shadow: inset 0 0 6px rgba(255,183,159,0.25);
    z-index: 1;
  }
  .bar-fill {
    background: linear-gradient(90deg, var(--fill), var(--accent));
    box-shadow: inset 0 0 8px rgba(255,130,85,0.25), 0 6px 18px rgba(255,130,85,0.35);
    z-index: 2;
  }
  .tick { position: absolute; top: -10px; width: 1px; height: 48px; background: rgba(33,33,33,0.12); }
  .tick-label { position: absolute; top: 38px; transform: translateX(-50%); font-size: 12px; color: #6b6b6b; }
  .milestone-dot {
    position: absolute; top: 50%; transform: translate(-50%, -50%);
    width: 10px; height: 10px; background: #212121; border-radius: 50%;
    box-shadow: 0 0 0 6px rgba(33,33,33,0.10);
    z-index: 3;
  }

  .legend { display:flex; gap:16px; align-items:center; margin: 8px 0 0; color: var(--muted); font-size: 13px; }
  .key { display:flex; align-items:center; gap:8px; }
  .swatch { width:14px; height:14px; border-radius:4px; border: 1px solid rgba(33,33,33,0.12); }
  .swatch.written { background: var(--fill-muted); }
  .swatch.settled { background: var(--fill); }

  .celebrate { position: fixed; inset: 0; pointer-events: none; overflow: hidden; }
  .confetti { position: absolute; width: 8px; height: 10px; opacity: 0; animation: fall 1400ms ease-out forwards; }
  @keyframes fall {
    0% { transform: translateY(-20vh) rotate(0deg); opacity: 0; }
    10% { opacity: 1; }
    100% { transform: translateY(110vh) rotate(540deg); opacity: 0; }
  }

  .footer { display:flex; flex-wrap: wrap; justify-content: space-between; align-items:center; gap:12px; margin-top: 18px; color: var(--muted); font-size: 14px; }
  .badge {
    display:inline-flex; align-items:center; gap:8px; padding: 6px 10px;
    border-radius: 999px; border: 1px solid rgba(33,33,33,0.12);
    background: rgba(255,255,255,0.75); color: var(--text);
  }
  .status-dot { width:10px; height:10px; border-radius:50%; background: var(--good); box-shadow: 0 0 0 4px rgba(255,130,85,0.22); }

  .pace { display:flex; gap:10px; align-items:center; }
  .pill { padding:6px 10px; border-radius:999px; border:1px solid rgba(33,33,33,0.12); background: rgba(255,255,255,0.6); font-weight:600; }
  .pill.ok { color:var(--good); border-color: rgba(255,130,85,0.35); }
  .pill.warn, .pill.bad { color:#212121; border-color: rgba(33,33,33,0.25); }
</style>
</head>
<body>
<div class="card">
  <div class="header">
    <div class="title" id="title">Monthly Settled Revenue Progress</div>
    <div class="updated" id="updated">—</div>
  </div>

  <div class="numbers">
    <div class="big" id="bigNumber">£0<span class="sm">of £1,000,000</span></div>
    <div class="target" id="pct">0% of target</div>
  </div>

  <!-- SINGLE BAR: Written (muted) behind Settled (bright) -->
  <div class="bar-title">
    <span>Progress this month</span>
    <span class="bar-value" id="settledValue">£0</span>
  </div>
  <div class="bar-wrap" id="barWrap">
    <div class="bar-fill-written" id="barFillWritten"></div>
    <div class="bar-fill" id="barFillSettled"></div>
    <!-- milestone ticks & dots injected here -->
  </div>
  <div class="legend">
    <div class="key"><span class="swatch written"></span> Written: <span id="writtenValue">£0</span></div>
    <div class="key"><span class="swatch settled"></span> Settled</div>
  </div>

  <div class="footer">
    <div class="badge"><span class="status-dot"></span> Auto refreshing every 60s</div>
    <div class="pace" id="pace">
      <span class="pill" id="paceStatus">Calculating pace</span>
      <span id="paceDetail">—</span>
    </div>
    <div class="badge" id="bizDays"><span id="bizDaysCount">—</span></div>
  </div>
</div>

<div class="celebrate" id="celebrate"></div>

<script>
  // === CONFIG ===
  const API_URL = "https://script.google.com/macros/s/AKfycby0cxbu0LgzmjpyNZjx9QWU6Emzpk7TJVZNLYE9KdFdgvKqYFfGoELqwJgZI5-yLlG2/exec";
  const REFRESH_MS = 60000;
  const DEFAULT_MILESTONES = [250000, 500000, 750000, 1000000];

  // === UI REFS ===
  const titleEl = document.getElementById('title');
  const bigNumber = document.getElementById('bigNumber');
  const pctEl = document.getElementById('pct');
  const updatedEl = document.getElementById('updated');

  const barWrap = document.getElementById('barWrap');
  const barFillSettled = document.getElementById('barFillSettled');
  const barFillWritten = document.getElementById('barFillWritten');
  const settledValueEl = document.getElementById('settledValue');
  const writtenValueEl = document.getElementById('writtenValue');

  const celebrate = document.getElementById('celebrate');
  const paceStatus = document.getElementById('paceStatus');
  const paceDetail = document.getElementById('paceDetail');
  const bizDaysCountEl = document.getElementById('bizDaysCount');

  const celebrated = new Set();

  function fmtGBP(n) {
    try { return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(n); }
    catch { return '£' + Math.round(n).toLocaleString('en-GB'); }
  }

  function setMonthHeader() {
    const now = new Date();
    const monthLabel = now.toLocaleString('en-GB', { month: 'long', year: 'numeric' });
    titleEl.textContent = `${monthLabel} Settled Revenue Progress`;
  }

  function clearMilestones(){
    [...barWrap.querySelectorAll('.tick,.tick-label,.milestone-dot')].forEach(n => n.remove());
  }
  function injectMilestones(milestones, target) {
    clearMilestones();
    milestones.forEach(ms => {
      const pct = Math.max(0, Math.min(100, (ms / target) * 100));
      const tick = document.createElement('div'); tick.className = 'tick'; tick.style.left = pct + '%'; barWrap.appendChild(tick);
      const dot = document.createElement('div'); dot.className = 'milestone-dot'; dot.style.left = pct + '%'; barWrap.appendChild(dot);
      const label = document.createElement('div'); label.className = 'tick-label'; label.style.left = pct + '%'; label.textContent = fmtGBP(ms); barWrap.appendChild(label);
    });
  }

  function confettiBurst() {
    const colors = ['#ff8255', '#212121', '#efeee8', '#ff9c77'];
    const count = 120; const w = window.innerWidth;
    for (let i = 0; i < count; i++) {
      const piece = document.createElement('div');
      piece.className = 'confetti';
      piece.style.left = Math.random() * w + 'px';
      piece.style.background = colors[(Math.random() * colors.length) | 0];
      piece.style.animationDelay = (Math.random() * 200) + 'ms';
      piece.style.transform = `translateY(-${Math.random()*60+20}vh) rotate(${Math.random()*180}deg)`;
      celebrate.appendChild(piece);
      setTimeout(() => piece.remove(), 2000);
    }
  }

  function maybeCelebrate(current, milestones) {
    milestones.forEach(ms => { if (current >= ms && !celebrated.has(ms)) { celebrated.add(ms); confettiBurst(); } });
  }

  async function fetchData() {
    const res = await fetch(API_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to fetch data');
    return res.json();
  }

  function setBars(current, written, target) {
    // clamp widths to [0,100]
    const pctWritten = target > 0 ? Math.min(100, (written/target)*100) : 0;
    const pctSettled = target > 0 ? Math.min(100, (current/target)*100) : 0;

    barFillWritten.style.width = pctWritten + '%';
    barFillSettled.style.width = pctSettled + '%';

    settledValueEl.textContent = fmtGBP(current);
    writtenValueEl.textContent = fmtGBP(written);

    bigNumber.innerHTML = `${fmtGBP(current)}<span class="sm">of ${fmtGBP(target)}</span>`;
    pctEl.textContent = `${Math.floor(pctSettled)}% of target`;
  }

  function daysInMonth(year, monthIndex) { return new Date(year, monthIndex + 1, 0).getDate(); }
  function isBusinessDay(d){ const w = d.getDay(); return w >= 1 && w <= 5; }
  function lastBusinessDayOfMonth(fromDate = new Date()){
    const y = fromDate.getFullYear(), m = fromDate.getMonth();
    let d = new Date(y, m + 1, 0); while(!isBusinessDay(d)) d.setDate(d.getDate() - 1); return d;
  }
  function businessDaysLeft(fromDate = new Date()) {
    const y = fromDate.getFullYear(), m = fromDate.getMonth();
    const end = lastBusinessDayOfMonth(fromDate);
    const start = new Date(y, m, fromDate.getDate()); start.setHours(0,0,0,0);
    let d = new Date(start), count = 0; while (d <= end) { if (isBusinessDay(d)) count++; d.setDate(d.getDate() + 1); }
    return Math.max(0, count);
  }

  function computePace(current, target) {
    const now = new Date(); const y = now.getFullYear(); const m = now.getMonth();
    const totalDays = daysInMonth(y, m); const elapsedDays = now.getDate();
    const requiredDaily = target / totalDays;
    const achievedDaily = elapsedDays > 0 ? current / elapsedDays : 0;
    const expectedByToday = (target * elapsedDays) / totalDays;
    const delta = current - expectedByToday; const projected = achievedDaily * totalDays;
    return { requiredDaily, achievedDaily, expectedByToday, delta, projected, totalDays, elapsedDays };
  }

  function setPaceUI(current, target) {
    const p = computePace(current, target);
    const sign = p.delta >= 0 ? 'ok' : (p.delta > -0.02*target ? 'warn' : 'bad');
    paceStatus.classList.remove('ok','warn','bad'); paceStatus.classList.add(sign);
    if (p.delta >= 0) {
      paceStatus.textContent = 'On pace';
      paceDetail.textContent = `Ahead by ${fmtGBP(Math.abs(p.delta))}. Projected ${fmtGBP(p.projected)} by month end.`;
    } else {
      paceStatus.textContent = 'Behind pace';
      paceDetail.textContent = `Behind by ${fmtGBP(Math.abs(p.delta))}. Need about ${fmtGBP(p.requiredDaily)} per day. Current pace ${fmtGBP(p.achievedDaily)} per day.`;
    }
  }

  function updateBizDaysUI(){
    const bLeft = businessDaysLeft(new Date());
    if (bizDaysCountEl) bizDaysCountEl.textContent = `${bLeft} business days left this month`;
  }

  async function refresh() {
    try {
      const data = await fetchData();

      // Defensive: if API doesn't send 'written', fall back to 0 and warn
      const current = Number(data.current) || 0;
      const target  = Number(data.target)  || 1000000;
      const written = ('written' in data) ? (Number(data.written) || 0) : 0;
      if (!('written' in data)) {
        console.warn("API payload has no 'written' field. Showing 0. Update your Apps Script to include Metrics!C2.");
      }

      const milestones = Array.isArray(data.milestones) && data.milestones.length ? data.milestones : DEFAULT_MILESTONES;

      injectMilestones(milestones, target);
      setBars(current, written, target);

      setPaceUI(current, target);
      updateBizDaysUI();

      const ts = data.updated || Date.now();
      updatedEl.textContent = `Updated ${new Date(ts).toLocaleString('en-GB')}`;

      maybeCelebrate(current, milestones);
    } catch (err) {
      updatedEl.textContent = 'Error fetching data';
      console.error(err);
    }
  }

  setMonthHeader();
  refresh();
  setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
