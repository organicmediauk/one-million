<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Monthly £1m Milestone Counter</title>
<style>
  :root {
    --bg: #0b1020;
    --card: #121933;
    --track: #1d2750;
    --fill: #6aa6ff;
    --accent: #9ad1ff;
    --text: #e9f0ff;
    --muted: #95a0c7;
    --good: #33d69f;
    --warn: #ffd166;
    --bad: #ef476f;
  }
  * { box-sizing: border-box; }
  body {
    margin: 0; height: 100vh; display: grid; place-items: center;
    background: radial-gradient(1200px 600px at 20% -10%, #16224d 0%, #0b1020 45%, #0b1020 100%), var(--bg);
    color: var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
  }
  .card {
    width: min(1100px, 92vw); padding: 28px; background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.45), inset 0 1px 0 rgba(255,255,255,0.05);
    backdrop-filter: blur(8px);
  }
  .header { display:flex; align-items:baseline; justify-content:space-between; gap:16px; margin-bottom: 18px; }
  .title { font-size: clamp(20px, 3.2vw, 28px); letter-spacing: 0.3px; font-weight: 700; }
  .updated { font-size: 12px; color: var(--muted); }

  .numbers {
    display:grid; grid-template-columns: 1fr auto; gap: 14px; align-items: end; margin-bottom: 18px;
  }
  .big { font-size: clamp(28px, 6vw, 56px); font-weight: 800; line-height: 1; }
  .big .sm { font-weight: 600; font-size: 0.48em; color: var(--muted); margin-left: 8px; }
  .target { text-align: right; color: var(--muted); font-size: clamp(12px, 1.8vw, 16px); }

  .bar-wrap {
    position: relative; height: 28px; background: var(--track);
    border-radius: 999px; overflow: hidden; border: 1px solid rgba(255,255,255,0.08);
  }
  .bar-fill {
    height: 100%; width: 0%;
    background: linear-gradient(90deg, var(--fill), var(--accent));
    box-shadow: inset 0 0 12px rgba(255,255,255,0.18), 0 6px 18px rgba(106,166,255,0.35);
    transition: width 900ms cubic-bezier(.2,.8,.2,1);
  }
  .tick { position: absolute; top: -10px; width: 1px; height: 48px; background: rgba(255,255,255,0.2); }
  .tick-label { position: absolute; top: 38px; transform: translateX(-50%); font-size: 12px; color: var(--muted); }
  .milestone-dot {
    position: absolute; top: 50%; transform: translate(-50%, -50%);
    width: 10px; height: 10px; background: #fff; border-radius: 50%;
    box-shadow: 0 0 0 6px rgba(255,255,255,0.15);
  }

  .celebrate { position: fixed; inset: 0; pointer-events: none; overflow: hidden; }
  .confetti { position: absolute; width: 8px; height: 10px; opacity: 0; animation: fall 1400ms ease-out forwards; }
  @keyframes fall {
    0% { transform: translateY(-20vh) rotate(0deg); opacity: 0; }
    10% { opacity: 1; }
    100% { transform: translateY(110vh) rotate(540deg); opacity: 0; }
  }

  .footer { display:flex; flex-wrap: wrap; justify-content: space-between; align-items:center; gap:12px; margin-top: 18px; color: var(--muted); font-size: 14px; }
  .badge { display:inline-flex; align-items:center; gap:8px; padding: 6px 10px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); }
  .status-dot { width:10px; height:10px; border-radius:50%; background: var(--good); box-shadow: 0 0 0 4px rgba(51,214,159,0.15); }

  .pace { display:flex; gap:10px; align-items:center; }
  .pill { padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.04); font-weight:600; }
  .pill.ok { color:#d9fff0; border-color: rgba(51,214,159,0.35); }
  .pill.warn { color:#fff6db; border-color: rgba(255,209,102,0.35); }
  .pill.bad { color:#ffe1e8; border-color: rgba(239,71,111,0.35); }
</style>
</head>
<body>
<div class="card">
  <div class="header">
    <div class="title" id="title">Monthly Settled Revenue Progress</div>
    <div class="updated" id="updated">—</div>
  </div>

  <div class="numbers">
    <div class="big" id="bigNumber">£0<span class="sm">of £1,000,000</span></div>
    <div class="target" id="pct">0% of target</div>
  </div>

  <div class="bar-wrap" id="barWrap">
    <div class="bar-fill" id="barFill"></div>
    <!-- milestone ticks & dots injected here -->
  </div>

  <div class="footer">
    <div class="badge"><span class="status-dot"></span> Auto refreshing every 60s</div>
    <div class="pace" id="pace">
      <span class="pill" id="paceStatus">Calculating pace</span>
      <span id="paceDetail">—</span>
    </div>
    <div class="badge" id="bizDays"><span id="bizDaysCount">—</span></div>
    <div class="badge" id="bizCountdown">⏳ <span id="bizCountdownText">—</span></div>
  </div>
</div>
</div>

<div class="celebrate" id="celebrate"></div>

<script>
  // === CONFIG ===
  const API_URL = "https://script.google.com/macros/s/AKfycby0cxbu0LgzmjpyNZjx9QWU6Emzpk7TJVZNLYE9KdFdgvKqYFfGoELqwJgZI5-yLlG2/exec";
  const REFRESH_MS = 60000;
  const DEFAULT_MILESTONES = [250000, 500000, 750000, 1000000];

  // === UI REFS ===
  const titleEl = document.getElementById('title');
  const bigNumber = document.getElementById('bigNumber');
  const pctEl = document.getElementById('pct');
  const updatedEl = document.getElementById('updated');
  const barFill = document.getElementById('barFill');
  const barWrap = document.getElementById('barWrap');
  const celebrate = document.getElementById('celebrate');
  const paceStatus = document.getElementById('paceStatus');
  const paceDetail = document.getElementById('paceDetail');
  const bizDaysEl = document.getElementById('bizDays');
  const bizDaysCountEl = document.getElementById('bizDaysCount');
  const bizCountdownText = document.getElementById('bizCountdownText');

  // Track milestone celebrations so we only fire once per threshold (per page session)
  const celebrated = new Set();

  function fmtGBP(n) {
    try {
      return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP', maximumFractionDigits: 0 }).format(n);
    } catch {
      return '£' + Math.round(n).toLocaleString('en-GB');
    }
  }

  function setMonthHeader() {
    const now = new Date();
    const monthLabel = now.toLocaleString('en-GB', { month: 'long', year: 'numeric' });
    titleEl.textContent = `${monthLabel} Settled Revenue Progress`;
  }

  function injectMilestones(milestones, target) {
    // Clear old ticks/dots
    [...barWrap.querySelectorAll('.tick,.tick-label,.milestone-dot')].forEach(n => n.remove());

    milestones.forEach(ms => {
      const pct = Math.max(0, Math.min(100, (ms / target) * 100));
      const tick = document.createElement('div');
      tick.className = 'tick';
      tick.style.left = pct + '%';
      barWrap.appendChild(tick);

      const dot = document.createElement('div');
      dot.className = 'milestone-dot';
      dot.style.left = pct + '%';
      barWrap.appendChild(dot);

      const label = document.createElement('div');
      label.className = 'tick-label';
      label.style.left = pct + '%';
      label.textContent = fmtGBP(ms);
      barWrap.appendChild(label);
    });
  }

  function confettiBurst() {
    const colors = ['#6aa6ff', '#9ad1ff', '#33d69f', '#ffd166', '#ef476f', '#a78bfa'];
    const count = 120;
    const w = window.innerWidth;

    for (let i = 0; i < count; i++) {
      const piece = document.createElement('div');
      piece.className = 'confetti';
      piece.style.left = Math.random() * w + 'px';
      piece.style.background = colors[(Math.random() * colors.length) | 0];
      piece.style.animationDelay = (Math.random() * 200) + 'ms';
      piece.style.transform = `translateY(-${Math.random()*60+20}vh) rotate(${Math.random()*180}deg)`;
      celebrate.appendChild(piece);
      setTimeout(() => piece.remove(), 2000);
    }
  }

  function maybeCelebrate(current, milestones) {
    milestones.forEach(ms => {
      if (current >= ms && !celebrated.has(ms)) {
        celebrated.add(ms);
        confettiBurst();
      }
    });
  }

  async function fetchData() {
    const res = await fetch(API_URL, { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to fetch data');
    return res.json();
  }

  function setNumbers(current, target) {
    const pct = target > 0 ? Math.min(100, (current/target)*100) : 0;
    bigNumber.innerHTML = `${fmtGBP(current)}<span class="sm">of ${fmtGBP(target)}</span>`;
    pctEl.textContent = `${Math.floor(pct)}% of target`;
    barFill.style.width = pct + '%';
  }

  function daysInMonth(year, monthIndex) {
    return new Date(year, monthIndex + 1, 0).getDate();
  }

  // ===== Business day helpers & countdown =====
  function isBusinessDay(d){
    const w = d.getDay();
    return w >= 1 && w <= 5; // Mon–Fri
  }
  function businessDayEnd(date){
    const d = new Date(date);
    d.setHours(17,0,0,0); // 17:00 local end of business
    return d;
  }
  function lastBusinessDayOfMonth(fromDate = new Date()){
    const y = fromDate.getFullYear();
    const m = fromDate.getMonth();
    let d = new Date(y, m + 1, 0); // last day of month
    while(!isBusinessDay(d)){
      d.setDate(d.getDate() - 1);
    }
    return d;
  }
  function businessDaysLeft(fromDate = new Date()) {
    const y = fromDate.getFullYear();
    const m = fromDate.getMonth();
    const end = lastBusinessDayOfMonth(fromDate);
    const now = new Date(fromDate);

    let d = new Date(y, m, now.getDate());
    d.setHours(0,0,0,0);

    let count = 0;
    while (d <= end) {
      if (isBusinessDay(d)) count++;
      d.setDate(d.getDate() + 1);
    }

    // If today is a business day and we're past 17:00, don't count today
    if (isBusinessDay(now) && now > businessDayEnd(now)) count -= 1;

    return Math.max(0, count);
  }
  function nextBusinessDeadline(now = new Date()){
    const endOfMonthBD = businessDayEnd(lastBusinessDayOfMonth(now));
    // If we're beyond the last business deadline, fix to end-of-month business deadline
    if (now > endOfMonthBD) return endOfMonthBD;

    // If today is a business day and before 17:00, deadline is today 17:00
    if (isBusinessDay(now) && now < businessDayEnd(now)){
      return businessDayEnd(now);
    }
    // Otherwise, move to the next business day at 17:00
    let d = new Date(now);
    d.setDate(d.getDate() + 1);
    d.setHours(12,0,0,0);
    while(!isBusinessDay(d)){
      d.setDate(d.getDate() + 1);
    }
    return businessDayEnd(d);
  }
  function fmtDuration(ms){
    if (ms < 0) ms = 0;
    const totalSec = Math.floor(ms / 1000);
    const hrs = Math.floor(totalSec / 3600);
    const mins = Math.floor((totalSec % 3600) / 60);
    const secs = totalSec % 60;
    const pad = n => String(n).padStart(2,'0');
    return `${pad(hrs)}:${pad(mins)}:${pad(secs)}`;
  }

  function computePace(current, target) {
    const now = new Date();
    const y = now.getFullYear();
    const m = now.getMonth();
    const totalDays = daysInMonth(y, m);
    const elapsedDays = now.getDate(); // 1-based

    const requiredDaily = target / totalDays;
    const achievedDaily = elapsedDays > 0 ? current / elapsedDays : 0;
    const expectedByToday = (target * elapsedDays) / totalDays;
    const delta = current - expectedByToday; // positive if ahead

    const projected = achievedDaily * totalDays;

    return { requiredDaily, achievedDaily, expectedByToday, delta, projected, totalDays, elapsedDays };
  }

  function setPaceUI(current, target) {
    const p = computePace(current, target);
    const sign = p.delta >= 0 ? 'ok' : (p.delta > -0.02*target ? 'warn' : 'bad');

    paceStatus.classList.remove('ok','warn','bad');
    paceStatus.classList.add(sign);

    if (p.delta >= 0) {
      paceStatus.textContent = 'On pace';
      paceDetail.textContent = `Ahead by ${fmtGBP(Math.abs(p.delta))}. Projected ${fmtGBP(p.projected)} by month end.`;
    } else {
      paceStatus.textContent = 'Behind pace';
      paceDetail.textContent = `Behind by ${fmtGBP(Math.abs(p.delta))}. Need about ${fmtGBP(p.requiredDaily)} per day. Current pace ${fmtGBP(p.achievedDaily)} per day.`;
    }
  }

  function updateCountdownUI(){
    const bLeft = businessDaysLeft(new Date());
    if (bizDaysCountEl) bizDaysCountEl.textContent = `${bLeft} business days remaining (Mon–Fri)`;

    function tick(){
      const deadline = nextBusinessDeadline(new Date());
      const now = new Date();
      const ms = deadline - now;
      const label = (isBusinessDay(now) && now < businessDayEnd(now))
        ? "to today's 17:00"
        : `to ${deadline.toLocaleDateString('en-GB', { weekday:'short' })} 17:00`;
      if (bizCountdownText) bizCountdownText.textContent = `${fmtDuration(ms)} ${label}`;
    }
    tick();
    if (window.__bizCountdownInterval) clearInterval(window.__bizCountdownInterval);
    window.__bizCountdownInterval = setInterval(tick, 1000);
  }

  async function refresh() {
    try {
      const data = await fetchData();
      const current = Number(data.current) || 0;
      const target = Number(data.target) || 1000000;
      const milestones = Array.isArray(data.milestones) && data.milestones.length ? data.milestones : DEFAULT_MILESTONES;

      injectMilestones(milestones, target);
      setNumbers(current, target);
      setPaceUI(current, target);
      updateCountdownUI();

      const ts = data.updated || Date.now();
      updatedEl.textContent = `Updated ${new Date(ts).toLocaleString('en-GB')}`;

      maybeCelebrate(current, milestones);
    } catch (err) {
      updatedEl.textContent = 'Error fetching data';
      console.error(err);
    }
  }

  setMonthHeader();
  refresh();
  setInterval(refresh, REFRESH_MS);
</script>
</body>
</html>
